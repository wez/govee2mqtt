# Changelog

This file is automatically generated from the git commit history.

## [2025.11.01-86c12d14] - 2025-11-01 05:56

### ‚öôÔ∏è Miscellaneous

- Lan_api: workaround non-conforming LAN API devices

It seems that some newer devices are not complying with Govee's
own LAN API spec and are omitting the ip field from the scan
discovery packet.

Let's try defaulting it to the address from which we received
the discovery packet.

refs: https://github.com/wez/govee2mqtt/issues/437

## [2025.10.26-b29dee52] - 2025-10-26 09:27

### ‚öôÔ∏è Miscellaneous

- Bump actions/download-artifact from 4 to 5

Bumps [actions/download-artifact](https://github.com/actions/download-artifact) from 4 to 5.
- [Release notes](https://github.com/actions/download-artifact/releases)
- [Commits](https://github.com/actions/download-artifact/compare/v4...v5)

---
updated-dependencies:
- dependency-name: actions/download-artifact
  dependency-version: '5'
  dependency-type: direct:production
  update-type: version-update:semver-major
...

Signed-off-by: dependabot[bot] <support@github.com>
- Bump actions/checkout from 4 to 5

Bumps [actions/checkout](https://github.com/actions/checkout) from 4 to 5.
- [Release notes](https://github.com/actions/checkout/releases)
- [Changelog](https://github.com/actions/checkout/blob/main/CHANGELOG.md)
- [Commits](https://github.com/actions/checkout/compare/v4...v5)

---
updated-dependencies:
- dependency-name: actions/checkout
  dependency-version: '5'
  dependency-type: direct:production
  update-type: version-update:semver-major
...

Signed-off-by: dependabot[bot] <support@github.com>
- Update Docker instructions

The version: directive has been deprecated for quite some time, and has been replaced with the name: invocation.

https://forums.docker.com/t/docker-compose-yml-version-is-obsolete/141313

https://docs.docker.com/reference/compose-file/version-and-name/

Also adding optional bind mount for those who prefer to persist their data. Thanks!
- Http: fix route syntax

closes: https://github.com/wez/govee2mqtt/issues/483
closes: https://github.com/wez/govee2mqtt/issues/482
- Improve undoc and platform API errors on startup

This commit expands upon the error message reported during failed
initial disco via those APIs to explain why we cannot automatically
continue with the service startup, and to suggest the workaround, while
pointing at the tracking issue.

I'd wanted to make this non-blocking (you can see evidence of support
for that in this commit), but then I re-discovered the tracking issue
and the impact that such a thing would have on entity ids.  I don't
think it is a good idea to automatically proceed with altered entity
ids as it could wreak havoc with automations.

We now also will periodically (every 10 minutes) query those APIs for an
updated list of devices/rooms, which helps to detect newly adopted govee
devices after the service has started.

refs: https://github.com/wez/govee2mqtt/issues/76
- Addon: make it clearer that undoc and platform API require internet
- Support resolving hostnames for GOVEE_LAN_SCAN

closes: https://github.com/wez/govee2mqtt/issues/423
- Remove copypasta

### üêõ Bug Fixes

- Fixup warnings from more recent rust version

### üìö Documentation

- Docs: fixup copypasta from pv2mqtt project

## [2025.04.13-17d43d72] - 2025-04-13 14:02

### ‚öôÔ∏è Miscellaneous

- Add quirks to support H7133 and H7134 .

### üêõ Bug Fixes

- Fix humidity sensor json mapping

## [2025.01.04-2c39a50f] - 2025-01-04 15:32

### ‚öôÔ∏è Miscellaneous

- Revert ingress option

This needs some deeper handling in the http server dispatcher
to handle rewriting paths to be relative to the ingress controller
path prefix.

revert it for now

refs: https://github.com/wez/govee2mqtt/issues/306

## [2025.01.04-61765fd0] - 2025-01-04 15:00

### ‚öôÔ∏è Miscellaneous

- Hass: map addong config directory into container

This isn't used for anything yet
- Addon: set webui URL directly

we need to teach the redirect about the ingress
path that should be prefixed to the redirect URL,
but for now we can avoid the redirect by just setting
the correct URL to start.

refs: https://github.com/wez/govee2mqtt/issues/306

## [2025.01.04-abbd0b48] - 2025-01-04 14:17

### ‚öôÔ∏è Miscellaneous

- Maybe enable ingress support for hass addon

refs: https://github.com/wez/govee2mqtt/issues/306

## [2025.01.02-63e73826] - 2025-01-02 18:47

### ‚öôÔ∏è Miscellaneous

- Revert "prefer to use LAN API to apply light scenes"

This reverts commit c0545a87111a08465fd8fb9e717e5fff868a4b33; we'll
revisit this after a bit more investigation.

refs: https://github.com/wez/govee2mqtt/issues/354
refs: https://github.com/wez/govee2mqtt/issues/353
- Undoc_api: allow for null topic as well

We really can't do much with an entry that is null'd out like this,
but we should at least allow parsing that data without error.

refs: https://github.com/wez/govee2mqtt/issues/352

## [2025.01.01-ae1f0cc1] - 2025-01-01 13:40

### ‚öôÔ∏è Miscellaneous

- Undoc_api: most fields of OneClickIotRuleDevice are Optional

This should resolve a failure to parse the json response when
most fields are null'd out.

Turns out that we don't need the device field to activate
a one-click, so we skip that part of the struct that we're
extracting.

refs: https://github.com/wez/govee2mqtt/issues/352

## [2024.12.31-39564aea] - 2024-12-31 14:51

### ‚öôÔ∏è Miscellaneous

- H7172 IceMaker: add quirk to avoid IoT API

refs: https://github.com/wez/govee2mqtt/issues/343

## [2024.12.31-4d0b552f] - 2024-12-31 14:30

### ‚öôÔ∏è Miscellaneous

- Use light effect catalog to get device scenes for lan control

We default to querying the list of scene effects from the platform
API, but if you are running without the platform API credentials
(eg: want to run in LAN only mode) then we'd punt on getting
the list of scenes, even though we do actually have a way to
obtain that information to pave over gaps in the Govee API.

This commit adds a fallback to querying that light effect
catalog.

refs: https://github.com/wez/govee2mqtt/issues/349
- Add mqtt hostname in iot connect error messages

This makes it easier to understand errors if trace logging is not
enabled.

refs: https://github.com/wez/govee2mqtt/issues/345
- Undoc_api: allow cmdVersion to be missing or null

refs: https://github.com/wez/govee2mqtt/issues/324

### üìö Documentation

- Docs: update info about scenes and lan control
- Docs: clarify some FAQ

## [2024.12.30-c0545a87] - 2024-12-31 04:38

### ‚öôÔ∏è Miscellaneous

- Probably fix brightness slider updates

Partial revert of 8029cb5d7dd9b3ff7ee5ee2a161be97f9ca428ca

refs: https://github.com/wez/govee2mqtt/issues/348
- Prefer to use LAN API to apply light scenes

The updated logic for this should in theory be better in most cases?
Let's see!

## [2024.12.30-5de5b504] - 2024-12-30 21:00

### ‚öôÔ∏è Miscellaneous

- Invert sense of GOVEE_LAN_NO_MULTICAST

The docs say that `GOVEE_LAN_NO_MULTICAST=true` should *disable*
multicast discovery. This requires inverting the sense of the
environment variable.
- Add unit-related quirks to H5100 sensor

Fixes #240. It appears that this sensor uses the same reporting style as
H5103, which were addressed in #232.
- If-addrs: try 0.13 again

Previously, the build would fail on arm, this should now be
resolved.

refs: https://github.com/messense/if-addrs/issues/41
- Correct spelling of Fahrenheit. Fixes https://github.com/wez/govee2mqtt/issues/160
- Add H7052
- Avoid using deprecated color_mode flag

closes: #280
closes: #289
- Add quirk for H6003

closes: #267
- Makefile: add `make test` target
- Assume Fahrenheit as default temperature units

AFAICT, none of the govee devices report in celsius and all of them
needed a manual quirk to report correctly.

The hope is that we can skip that by assuming Fahrenheit by default.
- Bump the all group across 1 directory with 4 updates

Bumps the all group with 4 updates in the / directory: [chrono-tz](https://github.com/chronotope/chrono-tz), [csscolorparser](https://github.com/mazznoer/csscolorparser-rs), [tower-http](https://github.com/tower-rs/tower-http) and [thiserror](https://github.com/dtolnay/thiserror).


Updates `chrono-tz` from 0.9.0 to 0.10.0
- [Release notes](https://github.com/chronotope/chrono-tz/releases)
- [Commits](https://github.com/chronotope/chrono-tz/compare/v0.9.0...v0.10.0)

Updates `csscolorparser` from 0.6.2 to 0.7.0
- [Release notes](https://github.com/mazznoer/csscolorparser-rs/releases)
- [Changelog](https://github.com/mazznoer/csscolorparser-rs/blob/master/CHANGELOG.md)
- [Commits](https://github.com/mazznoer/csscolorparser-rs/compare/v0.6.2...v0.7.0)

Updates `tower-http` from 0.5.2 to 0.6.2
- [Release notes](https://github.com/tower-rs/tower-http/releases)
- [Commits](https://github.com/tower-rs/tower-http/compare/tower-http-0.5.2...tower-http-0.6.2)

Updates `thiserror` from 1.0.69 to 2.0.9
- [Release notes](https://github.com/dtolnay/thiserror/releases)
- [Commits](https://github.com/dtolnay/thiserror/compare/1.0.69...2.0.9)

---
updated-dependencies:
- dependency-name: chrono-tz
  dependency-type: direct:production
  update-type: version-update:semver-minor
  dependency-group: all
- dependency-name: csscolorparser
  dependency-type: direct:production
  update-type: version-update:semver-minor
  dependency-group: all
- dependency-name: tower-http
  dependency-type: direct:production
  update-type: version-update:semver-minor
  dependency-group: all
- dependency-name: thiserror
  dependency-type: direct:production
  update-type: version-update:semver-major
  dependency-group: all
...

Signed-off-by: dependabot[bot] <support@github.com>
- Implement more robust scene setting via LAN API

This commit adopts the excellent reverse engineering work
carried out by @AlgoClaw in https://github.com/egold555/Govee-Reverse-Engineering/issues/11#issuecomment-2565692233
as the way that we apply scenes.

This should result in fewer weird glitches and more accurate
application of the defined scenes.

My testing of this has been light; there is a unit test that
verifies the example from the walkthrough of the process,
and I used the CLI interface to apply a couple of scenes:

```console
./target/debug/govee lan-control --ip 192.168.1.201 scene Breathe
Loading environment overrides from "/home/wez/wez-personal/govee-rs/.env"
Computed ["o/8BAQIAAAAAAAAAAAAAAAAAAF4=", "MwUECgAAAAAAAAAAAAAAAAAAADg="]
```

## [2024.07.13-82ddc6e9] - 2024-07-13 15:22

### ‚öôÔ∏è Miscellaneous

- Add quirk for H7170 kettle to report proper temperature
- Add new fields from govee undoc api
- Update snapshots after undoc changes
- Add more reasons why lan API may not be working

closes: #219
- Bump docker/build-push-action from 5 to 6

Bumps [docker/build-push-action](https://github.com/docker/build-push-action) from 5 to 6.
- [Release notes](https://github.com/docker/build-push-action/releases)
- [Commits](https://github.com/docker/build-push-action/compare/v5...v6)

---
updated-dependencies:
- dependency-name: docker/build-push-action
  dependency-type: direct:production
  update-type: version-update:semver-major
...

Signed-off-by: dependabot[bot] <support@github.com>
- Ensure mode_name is topic safe

https://www.home-assistant.io/integrations/mqtt/#discovery-topic
- Update quirks for H5051, H5103, H5179.

I believe this should fix both #188 and #206. It works locally for my H5179 devices.
- Deps: bump to latest versions
- Add more delays on startup

There's been a number of reports of things showing as unavailable
after a haos reboot, let's try to slow things down a bit in the
interest of hass more reliably accepting the registration.

It's frustrating because the various mqtt events are supposed
to be the signal that things are ready, and they aren't!
- Revert if-addrs to 0.11

0.13 doesn't compile on armv7:

error[E0277]: the trait bound `i32: From<u32>` is not satisfied
  --> /cargo/registry/src/index.crates.io-6f17d22bba15001f/if-addrs-0.13.0/src/posix_not_mac.rs:75:50
   |
75 |                 tv_usec: timeout.subsec_micros().into(),
   |                                                  ^^^^ the trait `From<u32>` is not implemented for `i32`, which is required by `u32: Into<_>`
   |
   = help: the following other types implement trait `From<T>`:
             <i32 as From<bool>>
             <i32 as From<i16>>
             <i32 as From<i8>>
             <i32 as From<u16>>
             <i32 as From<u8>>
   = note: required for `u32` to implement `Into<i32>`
- Try to encourage addon to populate /app/assets

refs: https://github.com/wez/govee2mqtt/issues/123

### üêõ Bug Fixes

- Fixup some unused code warnings
- Fixup 'make addon'

Cause the image to be visible on the build host so that it
can be inspected and run.

## [2024.04.29-30cf7732] - 2024-04-29 16:38

### ‚öôÔ∏è Miscellaneous

- Update test fixtures
- Fix cargo fmt
- Bump baptiste0928/cargo-install from 2 to 3

Bumps [baptiste0928/cargo-install](https://github.com/baptiste0928/cargo-install) from 2 to 3.
- [Release notes](https://github.com/baptiste0928/cargo-install/releases)
- [Changelog](https://github.com/baptiste0928/cargo-install/blob/main/CHANGELOG.md)
- [Commits](https://github.com/baptiste0928/cargo-install/compare/v2...v3)

---
updated-dependencies:
- dependency-name: baptiste0928/cargo-install
  dependency-type: direct:production
  update-type: version-update:semver-major
...

Signed-off-by: dependabot[bot] <support@github.com>
- Adjust no-response schedule
- Update SKUS.md

Add additional fan SKUs that I can confirm work with version 2024.01.24-ea3cd430
- Addon: set key/password fields to password type in schema

closes: https://github.com/wez/govee2mqtt/issues/168

### üöÄ Features

- Feat(sensor): add `state_class=measurement` to temp./humid.

## [2024.01.24-ea3cd430] - 2024-01-24 16:00

### ‚öôÔ∏è Miscellaneous

- Don't insert empty scene to empty list of scenes

refs: https://github.com/wez/govee2mqtt/issues/100
- Fix link
- Bump the all group with 4 updates

Bumps the all group with 4 updates: [env_logger](https://github.com/rust-cli/env_logger), [clap-num](https://github.com/newAM/clap-num), [uuid](https://github.com/uuid-rs/uuid) and [openssl](https://github.com/sfackler/rust-openssl).


Updates `env_logger` from 0.10.1 to 0.10.2
- [Release notes](https://github.com/rust-cli/env_logger/releases)
- [Changelog](https://github.com/rust-cli/env_logger/blob/main/CHANGELOG.md)
- [Commits](https://github.com/rust-cli/env_logger/compare/v0.10.1...v0.10.2)

Updates `clap-num` from 1.0.2 to 1.1.1
- [Release notes](https://github.com/newAM/clap-num/releases)
- [Changelog](https://github.com/newAM/clap-num/blob/main/CHANGELOG.md)
- [Commits](https://github.com/newAM/clap-num/compare/1.0.2...1.1.1)

Updates `uuid` from 1.6.1 to 1.7.0
- [Release notes](https://github.com/uuid-rs/uuid/releases)
- [Commits](https://github.com/uuid-rs/uuid/compare/1.6.1...1.7.0)

Updates `openssl` from 0.10.62 to 0.10.63
- [Release notes](https://github.com/sfackler/rust-openssl/releases)
- [Commits](https://github.com/sfackler/rust-openssl/compare/openssl-v0.10.62...openssl-v0.10.63)

---
updated-dependencies:
- dependency-name: env_logger
  dependency-type: direct:production
  update-type: version-update:semver-patch
  dependency-group: all
- dependency-name: clap-num
  dependency-type: direct:production
  update-type: version-update:semver-minor
  dependency-group: all
- dependency-name: uuid
  dependency-type: direct:production
  update-type: version-update:semver-minor
  dependency-group: all
- dependency-name: openssl
  dependency-type: direct:production
  update-type: version-update:semver-patch
  dependency-group: all
...

Signed-off-by: dependabot[bot] <support@github.com>
- Improve error message if binding http port fails

refs: https://github.com/wez/govee2mqtt/issues/103
- NOCHANGELOG ignore dependabot updates
- H7173: update gearMode label -> Heat
- H7173: fix work mode default values

refs: https://github.com/wez/govee2mqtt/issues/100
- H713B: add quirk for temperature scale

refs: https://github.com/wez/govee2mqtt/issues/108
- Mqtt: avoid using auto_id for the client id

This feature requires server side support, and some users have
that functionality disabled.

Instead, just compute a uuid to produce a randomized id.

closes: https://github.com/wez/govee2mqtt/issues/106
- Improve error context if http service fails to start

refs: https://github.com/wez/govee2mqtt/issues/103

## [2024.01.21-33e8cd7c] - 2024-01-21 15:45

### ‚öôÔ∏è Miscellaneous

- Insert blank scene/mode into list

This will prevent hass logging about the empty string being an invalid
mode for certain devices.

We report an empty string in cases where we don't know the state.

We obviously cannot set the scene to the empty string though,
so we will raise an error in that case.

refs: https://github.com/wez/govee2mqtt/issues/98

## [2024.01.21-088d4ca8] - 2024-01-21 14:10

### ‚öôÔ∏è Miscellaneous

- H6119: add quirk for this BLE-only device

closes: https://github.com/wez/govee2mqtt/issues/97

## [2024.01.20-94084d56] - 2024-01-21 03:53

### ‚öôÔ∏è Miscellaneous

- Suppress "do something about ..." for Modes

These are actually handled already, I just forgot to suppress
this earlier.

refs: https://github.com/wez/govee2mqtt/issues/94
- H5179: add quirk for temperature and humidity readings

refs: https://github.com/wez/govee2mqtt/issues/95

## [2024.01.19-ffca9c12] - 2024-01-20 04:22

### üêõ Bug Fixes

- Fix: some slider modes didn't get registered with hass

refs: https://github.com/wez/govee2mqtt/issues/93

## [2024.01.19-835bff82] - 2024-01-20 01:27

### ‚öôÔ∏è Miscellaneous

- H6053, H617[CEF]: add quirk for BLE-only devices

closes: https://github.com/wez/govee2mqtt/issues/77

## [2024.01.19-253f49bc] - 2024-01-20 00:46

### ‚öôÔ∏è Miscellaneous

- H6102 - add quirk about it being BLE-only for sure

refs: https://github.com/wez/govee2mqtt/issues/92

## [2024.01.19-027d65d5] - 2024-01-19 22:18

### ‚öôÔ∏è Miscellaneous

- H7171: have target temperature match state in platform API

refs: https://github.com/wez/govee2mqtt/issues/91
- Use nightlightToggle state for light state when available

refs: https://github.com/wez/govee2mqtt/issues/89

### üßπ Refactor

- Refactor: simplify logic for getting device cap state

## [2024.01.19-429ab1c5] - 2024-01-19 15:35

### ‚öôÔ∏è Miscellaneous

- Poll smart kettles every minute when switched on

This helps have a less state temperature reading for the device

## [2024.01.19-90077b92] - 2024-01-19 15:02

### ‚öôÔ∏è Miscellaneous

- H7132: add quirk to note the units of the device

refs: https://github.com/wez/govee2mqtt/issues/90
- Try to improve handling of light control for appliances

refs: https://github.com/wez/govee2mqtt/issues/89

## [2024.01.18-4475eb63] - 2024-01-19 01:06

### ‚öôÔ∏è Miscellaneous

- H7151 and other dehumidifiers: enable humidifier entity

refs: https://github.com/wez/govee2mqtt/issues/86

## [2024.01.18-b83b7d15] - 2024-01-18 15:48

### ‚öôÔ∏è Miscellaneous

- Simplify poll-after-control logic

Introduce a coordinator that ensures that multiple
concurrent requests coming in via mqtt or http
for a given device are serialized, and that we
remember to poll their state shortly after
contolling them.
- H7142: parse Auto mode range from metadata

refs: https://github.com/wez/govee2mqtt/issues/81
- Defer building mode labels unless we are doing preset buttons

This just saves a little bit of memory

### üìö Documentation

- Docs: add FAQ entry about device ids not being MAC addresses
- Docs: expand LAN API troubleshooting and tips
- Docs: fix typo

## [2024.01.17-5df26edb] - 2024-01-18 05:14

### ‚öôÔ∏è Miscellaneous

- Add some notes about supported devices
- Add Mode/Scene select box for non-light devices with modes/scenes

refs: https://github.com/wez/govee2mqtt/issues/81
refs: https://github.com/wez/govee2mqtt/issues/59
refs: https://github.com/wez/govee2mqtt/issues/56
refs: https://github.com/wez/govee2mqtt/issues/22

### üìö Documentation

- Docs: fix link

### üßπ Refactor

- Refactor: move work mode parsing stuff to its own file

## [2024.01.17-f79b1d8a] - 2024-01-18 02:09

### üêõ Bug Fixes

- Fix overzealously showing preset buttons for things that should be sliders

refs: https://github.com/wez/govee2mqtt/issues/33
refs: https://github.com/wez/govee2mqtt/issues/81

## [2024.01.17-e8eb8dd7] - 2024-01-17 18:55

### ‚öôÔ∏è Miscellaneous

- Try to auto detect when to show preset button vs. slider
- Always use step size of 1 for temperature sliders

We were converting eg: 1C in 33.8F which is the correct absolute
value, but nonsense when talking about deltas.

refs: https://github.com/wez/govee2mqtt/issues/30
refs: https://github.com/wez/govee2mqtt/issues/59

## [2024.01.17-1114ad05] - 2024-01-17 18:32

### ‚öôÔ∏è Miscellaneous

- Adjust effective ble-only-ness. It's not ble-only if have platform API

refs: https://github.com/wez/govee2mqtt/issues/80
- Try to avoid fractional bounds on temperature sliders

### üêõ Bug Fixes

- Fixup representation of presets that have labels in metadata

refs: https://github.com/wez/govee2mqtt/issues/59

## [2024.01.17-29afb853] - 2024-01-17 18:02

### ‚öôÔ∏è Miscellaneous

- Set device_class to temperature/humidity as appropriate

Apparently this is how you trigger hass's auto conversion
of units.

refs: https://github.com/wez/govee2mqtt/issues/30
- Remove automatic "Parameter" suffix from mode labels
- Ensure mode preset buttons have a unique id

refs: https://github.com/wez/govee2mqtt/issues/30

### üêõ Bug Fixes

- Fix: allow parsing fractional temperature values

refs: https://github.com/wez/govee2mqtt/issues/30

## [2024.01.17-d6e027ab] - 2024-01-17 17:01

### ‚öôÔ∏è Miscellaneous

- H7171: show modes as preset buttons rather than sliders

refs: https://github.com/wez/govee2mqtt/issues/46
- H7131: show gearMode as preset buttons rather than sliders

refs: https://github.com/wez/govee2mqtt/issues/59
- Clamp temperature values to allowed range

refs: https://github.com/wez/govee2mqtt/issues/30

### üêõ Bug Fixes

- Fixup preset button labels

refs: https://github.com/wez/govee2mqtt/issues/30
- Fix: temperature limits set in C even though value is in F

refs: https://github.com/wez/govee2mqtt/issues/30

## [2024.01.17-2c728a28] - 2024-01-17 13:30

### üêõ Bug Fixes

- Fix: "device has no targettemperature" error

refs: https://github.com/wez/govee2mqtt/issues/56

## [2024.01.16-761f706a] - 2024-01-17 06:11

### ‚öôÔ∏è Miscellaneous

- H7171: add quirk for correct temperature units

refs: https://github.com/wez/govee2mqtt/issues/46
- Platform api: log result of control device attempt

This will help to prove/disprove that we did the right thing
in cases where the request seems to do nothing.

## [2024.01.16-9c624111] - 2024-01-17 02:23

### ‚öôÔ∏è Miscellaneous

- H7173: add quirk to note that it returns temperature in F

res: https://github.com/wez/govee2mqtt/issues/30
- Allow setting other temperature instances

The kettles have a different instance name than targetTemperature,
so allow setting that.

Reinstate decimal points in the computed temperature values to
avoid rounding/truncation issues compared to the govee app.

refs: https://github.com/wez/govee2mqtt/issues/69
refs: https://github.com/wez/govee2mqtt/issues/30
- H7173: show modes as "Activate Preset" buttons

I think these are a bit more accessible and intuitive, and allow
the user to rename the entity to match the names of the presets
in the app.

These buttons replace the original slider, which may still
function for folks upgrading, but won't be generated for
new installs.

refs: https://github.com/wez/govee2mqtt/issues/30
- Avoid sending state_topic:None for numbers

refs: https://github.com/wez/govee2mqtt/issues/30

## [2024.01.16-f8ed644b] - 2024-01-16 17:13

### ‚öôÔ∏è Miscellaneous

- H7130: device reports temp in F

refs: https://github.com/wez/govee2mqtt/issues/69
- Speculatively support changing target temperature

For devices that report temperature settings, this commit
will now expose a number entity in Celsius that will change
the target temperature when set.

None of the govee device metadata I've see so far report
the current temperature target, so this entity works in
optimistic mode.

It's possible that hass will keep it greyed out until
a value is reported for it, which will be kinda sucky.

refs: https://github.com/wez/govee2mqtt/issues/30
refs: https://github.com/wez/govee2mqtt/issues/47
refs: https://github.com/wez/govee2mqtt/issues/56
refs: https://github.com/wez/govee2mqtt/issues/59
refs: https://github.com/wez/govee2mqtt/issues/69
refs: https://github.com/wez/govee2mqtt/issues/75
- Add Temperature Scale option

* *Important*: when upgrading from an earlier version,
  you should delete any devices that have temperature
  sensors or controls and then stop the addon/docker container
  and ensure that you have set the temperature scale to your
  preference, then start the addon/container again.

This commit introduces a configuration option to specify your
preferred temperature scale as either "C" or "F" for Celsius
or Farenheit, respectively.

Entities created in home assistant will be set to use those units,
and convert to the underlying device units.

Since I don't own any devices with this characteristics, this change
has not been tested with real devices and it may not work; please
file an issue if you're having trouble with this!

refs: https://github.com/wez/govee2mqtt/issues/30
refs: https://github.com/wez/govee2mqtt/issues/47
refs: https://github.com/wez/govee2mqtt/issues/56
refs: https://github.com/wez/govee2mqtt/issues/59
refs: https://github.com/wez/govee2mqtt/issues/69
refs: https://github.com/wez/govee2mqtt/issues/75

## [2024.01.15-fba50505] - 2024-01-16 01:11

### ‚öôÔ∏è Miscellaneous

- Fix "has no codec for TypeId" errors

We can resolve these by catching and ignoring the error from the encode
attempt; the only reason it can fail is if we don't know how to encode
for a given device.

The we fallback to whatever other strategy is available: most likely
it will be a platform API call.

refs: https://github.com/wez/govee2mqtt/issues/73
refs: https://github.com/wez/govee2mqtt/issues/56

## [2024.01.14-3c7b22d4] - 2024-01-15 01:08

### ‚öôÔ∏è Miscellaneous

- Add foundation for per-sku IoT/BLE packet parsing
- Adopt macro for defining packet codecs

This makes it much simpler and more declarative when defining
both the encode and decode operations for a packet.
- Add singleton PacketManager
- Add NotifyHumidifierMode parser for H7160
- Switch humidifier controls to new per-sku-iot codec
- Parallelize initial lan disco device querying

I noticed that sometimes one or two of my devices would show
up with a warning about not responding on the lan api yet.
I think this is a consequence of a couple devices being a
bit tardy, and since we were polling them sequentially, we
could run out of time (we allow 10 seconds before printing
the initial status) to hear from them.

This commit runs that polling in parallel.  It's possible
that this will need to be tweaked in the future to apply
a semaphore to limit just how many devices we're trying
to reach at once; for homes with a large number of govee
devices on the lan this might get a bit gnarly.

We'll see!
- Number entities logged a warning instead of an info entry when controlled via mqtt
- Remove need to duplicate struct field types in packetcodec definition
- Move SetSceneCode to PacketCodec

This is used to try to set scenes via the lan api
- Update test snapshots to match recent packet changes
- Remove old packet encoder/decoder
- Use 2 decimal places for temperature and humidity

refs: https://github.com/wez/govee2mqtt/issues/68
- Publish temperature sensors in both C and F

refs: https://github.com/wez/govee2mqtt/issues/68
- H7143: tweak available entities

Suppress the Auto level number entity; it is part of the humidity
entity.

Re-label "Manual".

refs: https://github.com/wez/govee2mqtt/issues/22
- Make iot mqtt subscriber more robust

I was trying to improve debugging for reverse engineering purposes
and noticed that we were silently breaking.

What was happening was that the server was disconnecting us after
attempting to subscribe to device topic(s), and then the mqtt
client would leave our original subscription request hanging
indefinitely.

I've upgraded the mqtt client to cancel all pending waiters
on disconnect, and moved things around in here so that we can
catch and log this kind of error more assertively.
- Placeholder for iot-less humidifier control

Currently pointless when using the platform api
- Starting build legacy REST API client

The new platform API has a bunch of holes, and I'm hoping that
I can fill them with the old one.
- Add skeleton for old rest api

This is also write-only for appliances, and has less information
available than the platform API.
- Improve platform api support for Humidifiers

Where we don't have working IoT packet parsers for a humidifier,
we can fall back to the platform API.

Based on the capabilities reported for my device, that allows us
to report Manual mister level and mode, and to set (but not report)
the target humidity.

The write-only aspect of that API is a bit frustrating, but we
can set the entity up in optimistic mode and it seems to work
out OK in the hass UI.

Adjust the platform device polling to delay a few seconds before
polling; for my humidifier it takes a little bit for the API
to report the changed power state for my device if it was activated
as a side effect of setting the target humidity.

refs: https://github.com/wez/govee2mqtt/issues/22
refs: https://github.com/wez/govee2mqtt/issues/49 (maybe)
- Suppress CapabilitySwitch warning about useless switch states

There are some switches for which Govee provides a useless
empty string for the status rather than the boolean switch or
toggle state.

There's no point warning about those; nobody other than Govee
can fix them.
- Adopt work mode parser in humidifier logic
- Add Mode select entity for appliances

For humidifiers this is redundant with the existing list of modes
reported there, but for other appliance devices that haven't been
nicely integrated (heaters, fans and so on), this should give
some control over the modes.
- Refine reporting of mode when iot is enabled
- Fix potential integer underflow with target humidity

I think that the 128+value thing is the MSB being set rather than
being an offset value.

I saw an underflow happen once during testing, but it didn't emit
a stack trace and has happened again since, which suggests to me
that the device may not always set that bit.
- It's ok for these new methods to not be used yet

### üêõ Bug Fixes

- Fix updating mode select boxes

Need to use the name rather than the label for the mode.

### üßπ Refactor

- Refactor: break out work mode parser

## [2024.01.13-b7277f05] - 2024-01-13 13:09

### ‚öôÔ∏è Miscellaneous

- Quirks for H6121 and H6154

refs: https://github.com/wez/govee2mqtt/issues/40
- Avoid sending commands via IoT if quirk says not to

So far the iot support quirk has been used to filter
out notifications, but we should also try to avoid
sending commands via IoT if we're unsure about the
device.

refs: https://github.com/wez/govee2mqtt/issues/40
- Quirk for H6176

refs: https://github.com/wez/govee2mqtt/issues/49

## [2024.01.12-108ff95d] - 2024-01-13 04:36

### ‚öôÔ∏è Miscellaneous

- Ci: add name to build.yml workflow
- Potentially fix temperature sensor scaling

This commit introduces temperature (and humidity) units awareness
to the quirks layer, and defines some quirks for a handful of
devices.

These quirks allow us to correctly interpret the sensor readings
returned from the platform API for these devices, which do not
have any other metadata available from Govee to aid with this.

refs: https://github.com/wez/govee2mqtt/issues/58
refs: https://github.com/wez/govee2mqtt/issues/56
refs: https://github.com/wez/govee2mqtt/issues/47

It may also help to avoid misinterpreting the device power state
with the rgb light state on devices that are not primarily
lights, such as certain kinds of space heaters and humidifiers,
and with some light strips.

refs: https://github.com/wez/govee2mqtt/issues/59
refs: https://github.com/wez/govee2mqtt/issues/49

## [2024.01.12-ff6087e2] - 2024-01-13 03:15

### ‚öôÔ∏è Miscellaneous

- Don't log error about not listing scenes when platform api unavailable

Downgrade it to trace level so that it doesn't spam the logs or
mislead the user.

refs: https://github.com/wez/govee2mqtt/issues/60
- Switch last-will to unretained

There are a couple of users who report that their devices appear
as offline in hass seemingly for no good reason.

As far as I can see from the logs, they both appear to otherwise
be in good working order.

One of them has troubles that correlate with restarting hass
itself and/or the broker addon.  It seems like there may not
be good connection recovery in that situation.

The other seems to have no issues at all, except that the availability
topic somehow reverts back to offline.

What I suspect is some kind of intermittent network burp that somehow
triggers the last will message to be sent by the broker.  I'm also
a bit dubious of the retained nature of that message: I've read a
few things online where folks are working around retained messages
that somehow end up in a sticky state.

So, this commit turns off the retained flag in the hope that we
don't see any additional weird reports like this going forwards.

refs: https://github.com/wez/govee2mqtt/issues/37
refs: https://github.com/wez/govee2mqtt/issues/60

### üêõ Bug Fixes

- Fix "devices not support this instance" error message

This was actually harmless, but noisy.  The cause was that Govee
API returns this error message when trying to list the available
scenes for the device. When I started this project the API returned
an empty list, but as of a few days ago they made it return an
error condition for devices that don't support scenes. We ignore
the error and continue, so it didn't harm anything, it was
just noisy.

refs: https://github.com/wez/govee2mqtt/issues/58
refs: https://github.com/wez/govee2mqtt/issues/50
refs: https://github.com/wez/govee2mqtt/issues/59
refs: https://github.com/wez/govee2mqtt/issues/56

## [2024.01.12-afa3bc86] - 2024-01-12 17:01

### ‚öôÔ∏è Miscellaneous

- Include changelog in amended commit
- Add platform API metadata and state to Status entity attributes

Also add a "Request Platform API State" diagnostic button that
will force a query of the platform API state.

These can then be extracted from HASS and shared for troubleshooting
purposes using the template evaluation developer tools inside hass.

For example, this template reports both pieces of data for a specific
entity:

```
{{
{
  "meta": state_attr('sensor.smart_humidifier_status', 'platform_metadata'),
  "state": state_attr('sensor.smart_humidifier_status', 'platform_state'),
}
}}
```

## [2024.01.12-43f9e11d] - 2024-01-12 16:00

### ‚öôÔ∏è Miscellaneous

- Clarify tap-to-run vs. snapshot

refs: https://github.com/wez/govee2mqtt/issues/51
- Add sponsor section to readme
- Automate changelog creation for the addon

refs: https://github.com/wez/govee2mqtt/issues/52
- Add Status diagnostic to each device

It will indicate:

* `Available` - we've had a response from a poll request
  within the poll interval (approx 15 minutes)
* `Missing` - it's been longer than the poll interval
  (plus a little grace period) since we heard from the device.
* `Unknown` - we've never heard from the device

In addition, the following attributes are set on the entity:

* `iot` - the summarized device state based on the last
  response via IoT MQTT.
* `lan` - the summarized device state based on the last
  response via the LAN API
* `http` - the summarized device state basedon the last
  response via the Platform HTTP API
* `overall` - the most recent of `iot`, `lan`, `http`.

If any of the above are unknown, they will be null/missing
from the attributes.

refs: https://github.com/wez/govee2mqtt/issues/57

### üìö Documentation

- Docs: clarify how to set debug level in docker

## [2024.01.11-9564506d] - 2024-01-11 22:47

### ‚öôÔ∏è Miscellaneous

- Use signed numbers for undoc api

refs: https://github.com/wez/govee2mqtt/issues/54
- Try to auto-redact sensitive fields from the logs

Just wrap them in Redacted and it should take of hiding them
in most situations.

## [2024.01.11-6a00caa3] - 2024-01-11 14:15

### ‚öôÔ∏è Miscellaneous

- Avoid logging the iot credentials

it's too easy for someone not to realize what they are and
share them when filing issues.
- Add explicit timeout around AWS IoT connection attempt

refs: https://github.com/wez/govee2mqtt/issues/48

## [2024.01.10-8beb67bb] - 2024-01-11 04:41

### ‚öôÔ∏è Miscellaneous

- Put sku in Device Debug impl

This way it shows up in more places, which helps me contextualize
user problem reports better.
- Add issue state helper
- Add issue template
- Add FAQ

refs: https://github.com/wez/govee2mqtt/issues/43
refs: https://github.com/wez/govee2mqtt/issues/42
refs: https://github.com/wez/govee2mqtt/issues/41
closes: https://github.com/wez/govee2mqtt/issues/18
closes: https://github.com/wez/govee2mqtt/issues/17
- Create config.yml
- Faq link doesn't work in the form description
- Add section for collecting home assistant logs
- FAQ: add note about unavailable devices
- Don't auto assign bug label
- Allow for shorter packet lengths

refs: https://github.com/wez/govee2mqtt/issues/45
- Add note about how to see the logs when using docker
- Govee started to return some data here for some devices

So let's map it!

refs: https://github.com/wez/govee2mqtt/issues/33

### üêõ Bug Fixes

- Fixup permissions on no-response workflow

## [2024.01.10-a8f0a956] - 2024-01-10 14:49

### ‚öôÔ∏è Miscellaneous

- H610A platform API now has valid scene data

So remove the quirk that avoids it

refs: https://github.com/wez/govee2mqtt/issues/7#issuecomment-1884853614

## [2024.01.10-86c015b5] - 2024-01-10 14:31

### ‚öôÔ∏è Miscellaneous

- Potentially support various sensor types

In particular, this should enable temperature and humidity sensor
readings from H5103, but this is based on diagnostic output
provided by others; we will see if it actually works!

refs: https://github.com/wez/govee2mqtt/issues/27

## [2024.01.10-2ddf9413] - 2024-01-10 13:48

### ‚öôÔ∏è Miscellaneous

- Refine messaging to highlight when setup may need attention

Might help folks in situations like the one in the linked
issue.

refs: https://github.com/wez/govee2mqtt/issues/38
- Tweak waiting for settle message to show how many entities
- Consider "code" to be an alias for "status" in govee json responses

These aren't very consistent across the various endpoints :-/
- Add convenience method for HttpRequestFailed

Although I'm probably not going to use it in the immediate future
- Platform api now errors for my humidifier

It now yields:

```
{"requestId":"uuid","msg":"devices not support this instance","code":400,
```

which causes the previously cached-for-me empty results to be returned,
which is fine, but since this request failed it uses the negative ttl
of 1 minute, so we make this request every time we poll devices,
which is bad from an api quota limit perspective.

I could change the logic in the methods that fetch scenes to check
for this code and message string, but that seems brittle and error
prone.

So this commit takes a dual-pronged approach:

1. Bump the negative ttl to 5 minutes for any error in fetching scenes
2. Add in a quirk capability so that we know whether a device
   definitively does or does not support scenes and populate that
   for this particular device.  If we know it doesn't support them,
   we simply skip trying to populate scene metadata.
- Remove redundant Quirk label from startup diagnostics

the Debug impl will print it anyway, so this helps to make the
output less noisy.

## [2024.01.09-c0925c04] - 2024-01-10 04:09

### ‚öôÔ∏è Miscellaneous

- Add warning for weird work mode case
- Add read-after-write capability for platform api

There are a number of devices for which we don't know how to
fully decode data from the IoT API, but where the Platform API
will return us the data.

Contrive to read that data both in the periodic polls and also
to read it back after we've written a control request to the
device, so that we can more immediately reflect the new state.
- Allow for missing command in iot notif, and add some new fields

refs: https://github.com/wez/govee2mqtt/issues/36

## [2024.01.09-ab0af6b7] - 2024-01-09 17:28

### ‚öôÔ∏è Miscellaneous

- Potential fix for H5080 power outlet control

## [2024.01.09-509d1790] - 2024-01-09 16:28

### üêõ Bug Fixes

- Fix icon for triangle lights

refs: https://github.com/wez/govee2mqtt/issues/32

## [2024.01.09-c452466f] - 2024-01-09 15:04

### ‚öôÔ∏è Miscellaneous

- Add basic support for humidifer nightlight via iot

This gets the nightlight working for me on my H7160
- This shows target humidity for my humidifier

There's no control over the parameters yet; the way they are
implemented in the govee device is awkward to map into home
assistant, so some gymnastics will be required.
- Introduce EntityList and EntityInstance

These will make it easier to manage the various entities.
Starting off with the simplest global version entity.
- SceneConfig to EntityInstance
- Light to EntityInstance
- SwitchConfig to EntityInstance
- Populate work number parameter entities

They are added as number entities.

They don't respond to changes from hass yet.
- Round out H7160 humidifier support

This seems to get things in a reasonably complete state for me:

* Night light power, color and brightness
* Target humidity percent shown in humidifier entity
* Manual mist level control

Custom is not mapped as an entity; it seems rather complex in
the UI and the metadata is no use in understand how to encode
those behaviors.

This might happen to enable other humidifiers as well,
but I wouldn't be surprised if they need additional care
and attention to work reasonably.
- Improve handling of undoc api

refs: https://github.com/wez/govee2mqtt/issues/21
- Consider lan-api-support in a device as being a light

For devices that are not already known to be lan-api-capable
via our quirks database, if we detect them via lan-disco,
then we assume that they are in fact lights.

That said, in the linked issue, I don't think this would
have changed anything.

refs: https://github.com/wez/govee2mqtt/issues/32
- Downgrade platform API trust when it conflicts with LAN API

If the Platform API says that the device isn't an rgb light,
but we have available LAN API, then we decide not to trust
the platform API for that device.

Again, I don't think this will change the outcome in
the linked issue because this primarily affects us
when trying to change scenes.

refs: https://github.com/wez/govee2mqtt/issues/32
- Add log to indicate which technique was used to control device

So far, the absence of logging has meant that things were fine.
However, with multiple different choices for control, it makes
it difficult to suggest what to troubleshoot if a device doesn't
seem to respond.

This commit adds logging to show which strategy we used.
- Standardize on device.resolve_quirk()

It will synthesize some info in some cases, so we want to avoid
calling the raw resolve function.
- Check for LAN API connectivity on startup

Check and warn about possible LAN API configuration issues on startup.
- Allow for empty string when parsing embedded json

refs: https://github.com/wez/govee2mqtt/issues/36

### üßπ Refactor

- Refactor: move mqtt entity stuff to individual files

It was getting a bit difficult to navigate
- Refactor: Button to EntityInstance
- Refactor: move last of entity stuff out of service/hass
- Refactor: centralize publishing configs to hass

## [2024.01.07-92fb55e0] - 2024-01-07 17:29

### ‚öôÔ∏è Miscellaneous

- Synthesize a lan-compatible-light quirk for lan-disco'd devices

refs: https://github.com/wez/govee2mqtt/issues/24
- Enable use of IoT API to control lights

This should help in the case where the platform API is broken
for a device.

refs: https://github.com/wez/govee2mqtt/issues/15
- Add more friendly error message for inconsistent mqtt user/pass

refs: https://github.com/wez/govee2mqtt/issues/24#issuecomment-1880103929

## [2024.01.07-dc762b82] - 2024-01-07 15:50

### ‚öôÔ∏è Miscellaneous

- Expand quirks database

refs: https://github.com/wez/govee2mqtt/issues/24
- Hass: use quirks icon info to pre-populate entity icons

## [2024.01.07-118ee247] - 2024-01-07 14:18

### ‚öôÔ∏è Miscellaneous

- Group_id can be signed

I saw this in a user's logs
- Avoid a potential panic for devices with unusual device ids

refs: https://github.com/wez/govee2mqtt/issues/23

## [2024.01.07-5ac41477] - 2024-01-07 13:52

### ‚öôÔ∏è Miscellaneous

- Make all undoc DeviceSettings fields optional

refs: https://github.com/wez/govee2mqtt/issues/21#issuecomment-1880061957
- Update snapshots

## [2024.01.07-8b2527fc] - 2024-01-07 13:39

### ‚öôÔ∏è Miscellaneous

- Add Purge Caches button to "Govee to MQTT" device

This is helpful for situations like those in https://github.com/wez/govee2mqtt/issues/13
- Improve debugging context for mqtt_light_command

## [2024.01.07-8daf3a61] - 2024-01-07 13:00

### ‚öôÔ∏è Miscellaneous

- Add http-control info subcommand

This shows the data about the device that we got back
from the platform api
- Segments: don't interpret OFF as level=0

It doesn't work very well:

* Some devices don't actully have 0 level brightness
  (https://github.com/wez/govee2mqtt/issues/18) so they don't
  appear to turn off
* When doing light.turn_off for an area, setting segment levels
  has the side effect of turning the device back on, so the effect
  is that the light turns off and the immediately back on again.
- DeviceSettings sku may not be present

refs: https://github.com/wez/govee2mqtt/issues/21
- Iot: adjust notification schema

refs: https://github.com/wez/govee2mqtt/issues/14#issuecomment-1880050271
- Add quirk for H6159

refs: https://github.com/wez/govee2mqtt/issues/14#issuecomment-1880050091

## [2024.01.06-fc7ae219] - 2024-01-07 05:03

### ‚öôÔ∏è Miscellaneous

- Lan api: increase interval between devstatus requests

We send fewer packets and get responses more quickly overall
with this slightly longer delay.
- Wait a little to include lan info in startup diagnostic list
- Add trace when sending command via lan api

### üêõ Bug Fixes

- Fix line wrapping

### üßπ Refactor

- Refactor: DRY wrt. tokio::time

## [2024.01.06-5915ee93] - 2024-01-07 00:28

### ‚öôÔ∏è Miscellaneous

- Add ble_only-ness to quirks data

I noticed that one user's logs reported ble_only=true for
one device instance but false for another with the same sku(!)

## [2024.01.06-90dd2a57] - 2024-01-07 00:15

### ‚öôÔ∏è Miscellaneous

- Add awareness of humidifer and temp sensor fields

Doesn't do anything with them yet
- Trace: show platform and undoc device info on startup
- Don't try to poll ble-only devices
- Add quirk for H6141

refs: https://github.com/wez/govee2mqtt/issues/15
- Update test snapshots

## [2024.01.06-bb8fdbb3] - 2024-01-06 22:27

### ‚öôÔ∏è Miscellaneous

- Reinstate cached login

Will need to add a separate explicit cache clearing option.

refs: https://github.com/wez/govee2mqtt/issues/16
- Avoid registering a light with hass if it doesn't look like a light

refs: https://github.com/wez/govee2mqtt/issues/15
- Bump login negative cache to 15 mins

Not totally sure about this, but I'd rather avoid burning someone's
account access for 24 hours.

refs: https://github.com/wez/govee2mqtt/issues/16

## [2024.01.06-65f6cfc7] - 2024-01-06 22:01

### ‚öôÔ∏è Miscellaneous

- Add segment color and brightness control

Since Govee doesn't report the status of individual segments,
the entities are registered with home assistant in optimistic
mode, meaning that what you last set via home assistant is what
it believes to be the state of the device.

This is likely sufficient for eg: capturing a scene in home assistant,
but you should not use the state of one of the segment lights to
make any kind of automation decisions.

## [2024.01.06-0da21047] - 2024-01-06 19:43

### ‚öôÔ∏è Miscellaneous

- Try harder to get device id from iot notification

refs: https://github.com/wez/govee2mqtt/issues/14#issuecomment-1879773924
- Make port 4002 message more directive and obvious
- Show device info summary on startup

This will help to diagnose unusual-to-me devices when
folks report issues
- Enhance port 4002 message a bit more

## [2024.01.06-1c8564c4] - 2024-01-06 17:52

### ‚öôÔ∏è Miscellaneous

- Switch a couple more places to from_json

Should yield better error messages
- Try harder to derive sku from iot update

refs: https://github.com/wez/govee2mqtt/issues/14#issuecomment-1879762186
- Avoid trying to create entities for devices we can't control

We don't support BLE-only devices, for example

refs: https://github.com/wez/govee2mqtt/issues/14#issuecomment-1879762953

## [2024.01.06-b5e64128] - 2024-01-06 17:21

### ‚öôÔ∏è Miscellaneous

- Make more fields optional

refs: https://github.com/wez/govee2mqtt/issues/14#issuecomment-1879759175

## [2024.01.06-d884fb09] - 2024-01-06 17:08

### ‚öôÔ∏è Miscellaneous

- Improve error message around port 4002 bind error

refs: https://github.com/wez/govee2mqtt/issues/14#issuecomment-1879753791
- Allow topic to be optional in the device list

refs: https://github.com/wez/govee2mqtt/issues/14#issuecomment-1879755521

## [2024.01.06-0e7bd37e] - 2024-01-06 16:48

### ‚öôÔ∏è Miscellaneous

- Another optional field

## [2024.01.06-9d302ae6] - 2024-01-06 16:45

### ‚öôÔ∏è Miscellaneous

- Adjustments in caching and handling of ble devices

refs: https://github.com/wez/govee2mqtt/issues/14

## [2024.01.06-f8aad93d] - 2024-01-06 15:53

### ‚öôÔ∏è Miscellaneous

- Invalid cached credentials when we get a 401

refs: https://github.com/wez/govee2mqtt/issues/14

## [2024.01.06-bf77170b] - 2024-01-06 15:30

### ‚öôÔ∏è Miscellaneous

- Relax schema for device list

refs: https://github.com/wez/govee2mqtt/issues/14

## [2024.01.05-d995de93] - 2024-01-06 01:47

### ‚öôÔ∏è Miscellaneous

- Move docs around, add feature matrix
- Move scripts around
- Missed a bit
- Explicitly re-subscribe on MQTT reconnect

refs: https://github.com/wez/govee2mqtt/issues/3
- Update scripts path

### üìö Documentation

- Document some stuff about the LAN API

## [2024.01.05-465c3086] - 2024-01-05 21:13

### ‚öôÔ∏è Miscellaneous

- Remove un-publish step for hass entities

This was present because there was no way to update entities
when I was putting this logic together originally, making it
impossible to pick up changed configurations (eg: available effects for
lights).

In searching though hass issues today, I found
https://github.com/home-assistant/core/pull/100957 which allows for that
to happen.

So, let's remove the entity removal step.

refs: https://github.com/wez/govee2mqtt/issues/12

## [2024.01.05-27d5bd8a] - 2024-01-05 20:56

### ‚öôÔ∏è Miscellaneous

- Just skip scenes when there are no scenes

Eg: heaters, fan and humidifers can legitimately not have any.

refs: https://github.com/wez/govee2mqtt/issues/4
- Move undoc api from lan subcommand to its own subcommand

Add a bit of summarized output at the end.

refs: https://github.com/wez/govee2mqtt/issues/7
- Add caching to undoc oneclick stuff
- Proof of concept: activate one click scenes via cli
- Add REST api for one-clicks

refs: https://github.com/wez/govee2mqtt/issues/7
- Add oneclick scenes to hass

refs: https://github.com/wez/govee2mqtt/issues/7

## [2024.01.05-79e43690] - 2024-01-05 16:48

### ‚öôÔ∏è Miscellaneous

- Scene_caps: improve error message to show more context

We blend 4 different sources of data, try to make it easier to
figure out what we're seeing and from where.

refs: https://github.com/wez/govee2mqtt/issues/4

## [2024.01.05-52b63e97] - 2024-01-05 16:31

### ‚öôÔ∏è Miscellaneous

- Make more robust around reporting scenes

If we fail to figure out what scenes are available, that shouldn't
block bringing up the rest of the stuff that we know.

Improve error context and reporting along this code path.

Make it clear that if we fail up through the mqtt loop that we
are fatally broken, and terminate the process.

refs: https://github.com/wez/govee2mqtt/issues/4

## [2024.01.05-816211da] - 2024-01-05 14:33

### ‚öôÔ∏è Miscellaneous

- Add scene to the device state

Nothing populates it yet
- Track and report the current effect mode

Govee doesn't provide this, so we can only track the mode
that we were asked to set, and we'll make a reasonable
effort to figure out when the mode is no longer active;
we use a simple heuristic of clearing it when the color
or color temperature are changed.

refs: https://github.com/wez/govee2mqtt/issues/5

### üêõ Bug Fixes

- Fixup reading timezone from TZ env variable

## [2024.01.04-a61d4be3] - 2024-01-05 04:21

### ‚öôÔ∏è Miscellaneous

- Relax dsp_version_soft type

refs: https://github.com/wez/govee2mqtt/issues/4

## [2024.01.04-a76b0bbf] - 2024-01-05 04:07

### ‚öôÔ∏è Miscellaneous

- So close

## [2024.01.04-4211b51f] - 2024-01-05 03:59

### ‚öôÔ∏è Miscellaneous

- Adjust docker tags for when we tag

## [2024.01.04-b3bcdb47] - 2024-01-05 03:42

### üêõ Bug Fixes

- Fix condition for building addon image

## [2024.01.04-41d0368a] - 2024-01-05 02:30

### üêõ Bug Fixes

- Fix workflow

## [2024.01.04-71aac28c] - 2024-01-05 02:27

### ‚öôÔ∏è Miscellaneous

- Basically working lan disco
- Add client for new http api, parser for listing devices
- Query state via the http api
- Add method for getting a LanDevice directly by IP

This way, if you somehow know the IP of a device, you can talk
to it even if the discovery protocol isn't functioning for
whatever reason (eg: network topology).
- Add more options for lan discovery
- Tidy up disco output
- Tidy up list-http output
- Add simple lan control command
- Add brightness control
- Add color setting command
- Improve cache handling
- Add http device control
- Add scene control
- Add control of music modes
- Add support for sending raw BLE-encoded packets via the LAN API
- Add some undocumented api stuff
- Add types for parsing scene information
- Add lan scene control
- Tidy up
- Remove stray debug
- Proof of concept: connect to the iot mqtt endpoint
- Start building out the higher level structures
- Implement list-http in terms of state
- Dead code

these will be replaced slightly differently in a later commit
- Add unified list command

This does both the http platform api and lan discovery
- Pull in room name from undocumented api
- Update mosquitto dep

This includes support for the router. We're not using it here yet,
just wanted to get this out of the way
- Begin building out serve subcommand

this runs a little http server than can list devices
- Stash various clients into state
- Tweak how we start and wait for http server
- Hook up some lan controls to http api
- Hook up scene setting to http api
- Allow State to control via platform http api
- Add api for listing scenes for a device
- Add status polling via HTTP

We only try this when we think the state is stale and where there
is no LAN control available.
- Add cloud online status to status
- Rename http_api module to platform_api

This makes it less confusing wrt. Govee's older but higher versioned
HTTP API.
- Receive delta updates via AWS IoT connection
- We can now request status updates via iot mqtt
- Govee added a couple of new fields

Ultimately, I'll need to remove the deny-unknown-fields attribute
- Add base for a web page
- Show a live-updating list of devices
- Show version number in logs when starting service
- Allow controlling power state through web ui
- Add basic color picking to the ui
- Register lights with hass
- Revise how we poll for status changes with the lan api
- Centralize sorting scene names
- Add build bits for docker
- Rename to match final repo location
- Maybe kick off ci
- Ci: setup toolchain for cross
- Add basic readme and license
- Add the web assets to the docker image
- Bump the all group with 1 update ([#2](https://github.com/wez/govee2mqtt/issues/2))

Bumps the all group with 1 update: [k9](https://github.com/aaronabramov/k9).


Updates `k9` from 0.11.6 to 0.12.0
- [Commits](https://github.com/aaronabramov/k9/commits)

---
updated-dependencies:
- dependency-name: k9
  dependency-type: direct:production
  update-type: version-update:semver-minor
  dependency-group: all
...

Signed-off-by: dependabot[bot] <support@github.com>
Co-authored-by: dependabot[bot] <49699333+dependabot[bot]@users.noreply.github.com>
- Add test running and other checks for prs
- Mark as unavailable when we disconnect from mqtt
- Allow configuring disco options via env vars
- Add some more docs
- Add note about privacy and data use
- Let's see if this builds on windows
- Windows: build on push
- Refine windows build bits
- Continuously release windows builds
- Don't do the release stuff on pr
- Only do release on tag
- Ignore spaces when parsing the scan env var
- Fallback to platform api if iot mqtt is not working
- Add more debug around disco
- Prep for addon
- Add missing global_broadcast option to addon config page
- Good enough for folks to try
- Add translations for addon
- Remove windows build

It's interesting to note that it builds, but I don't really
want to support it, and I don't think anyone will really need it.
- Add addon install docs
- Add support for DIY scenes

refs: https://github.com/wez/govee2mqtt/issues/3
- Do a better job at filling out light metadata

brightness, rgb and color temp are now conditionally enabled
based on available metadata.

But: if we don't have any http metadata, we'll report no
capabilities at all. There's not much we can do about this
without having some kind of offline device metadata database
to consult.
- Adjust scene enumeration

Technically, scenes can be in the main device metadata; that's
what the docs show on one page, but on another they explain that
they factor it out into separate calls because it would otherwise
be too large.

The reality is that there are now three different places to look
and stitch things together, which is bit of a PITA.
- Add power switch for each light entity

Technically, this is redundant with the light itself, but the
thinking here is to allow for other kinds of devices that we
don't otherwise currently explicitly support.
- Only deny_unknown_fields in debug mode
- Cache: control stale reads on a per fetch basis
- Allow setting cache ttl based on fetched results
- Adjust ttls for credential caches
- Add new undoc api field

refs: https://github.com/wez/govee2mqtt/issues/6
- Improve error context around http requests
- Update test snapshot to go with f3eae71dff8f594e1230b8a7b5c5e7dfaa940d66
- Adjust for interesting govee schema

refs: https://github.com/wez/govee2mqtt/issues/4
- Merge in SKU scene data when listing scenes

Today the Govee Platform API is only returning the first scene
from the full list.

Merge in what we can retrieve from the SKU light effect library
so that we're not completely broken by this.
- Lossless enum repr for the govee enum types

Rather than show as just `Other`, capture the full text
string version of the variant.
- Simplify the enum string bits with a macro
- Add "hub" entity to help group and find the other devices

Adds a "Govee to MQTT" virtual device and marks all others as being
connected via this device.
- Improve handling of commands the change multiple params at once
- Allow concurrent handling of mqtt commands
- Add music modes to the list of effects

There are a couple of caveats with this:

* Technically, the modes accept a color and sensitivity, but hass
  doesn't provide a great way to configure these values as part
  of its effects interface

* Due to layering, it's not super simple to expose these as
  eg: a number entity and a text entity; it is possible, but it
  is a bit more work than is perhaps needed immediately.

* Today, Govee seems to be having a data problem in the Platform
  API; a number of scenes are missing and there are only a subset
  of the total number of music modes being reported via the API.
  Hopefully they will fix this soon!  I've also noticed that the
  snapshot of the data I captured the other day doesn't 100%
  match the list of modes reported in the Govee App.

As for this commit: it simply defaults to automatic color and 100%
sensitivity when activating the effect.  It's likely good enough
for the moment.

refs: https://github.com/wez/govee2mqtt/issues/8
- Remove stray debug
- Add quirks for H610A

At the time of writing, the platform API doesn't return correct
information for this device, and refuses to control it appropriately.

This commit adds the concept of a quirks database that can be used
to override the metadata and try to arrive at a better outcome.

This is sufficient to regain color and brightness control over this
device.

For scenes, this commit attempts to use the fruits of some reverse
engineering to compute a scene code to send via an undocumented
part of the LAN API.  In practice, this is most reliable with
scene codes that fit in a single byte; the others likely need
to get routed via the IoT MQTT connection.

That can be examined in a follow up commit.

refs: https://github.com/wez/govee2mqtt/issues/7
- Redact email, key, password from run.sh output
- Explicitly manipulate the addon version number

I'd assumed that addons were versioned just like docker,
but they aren't.  You won't get an option to update if
it is just using "latest" all the time.

I suppose that makes sense for explicit point in time
releases, but it is a bit frustrating for continuous
delivery.

This commit adds a script to make it convenient to
explicitly tag and bump a version number.

### üêõ Bug Fixes

- Fix some unused code warnings
- Fix some warnings
- Fix tables
- Fix 7z invocation
- Fix copypaste in docker-compose.yml
- Fixup de-reg and re-reg of entity configs on startup

I noticed that sometimes only the power switch was being
registered on startup.

Let's get a bit better at ordering of the config creates/deletes
and allowing settle time between each of the phases.

### üßπ Refactor

- Refactor to structure more like my pview project
- Refactor: move cache to own module
- Refactor scene+diy scene listing
- Refactor entity setup

Make it a bit easier to add different kinds of entities, and
generate entities for the various on_off and toggles reported
from the platform API.

Note however that the platform API doesn't return any useful
state for anything other than the light color and power state
at the time of writing, so this is a bit meh.

<!-- generated by git-cliff -->
